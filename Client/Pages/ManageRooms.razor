@page "/manage/rooms"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

<h3 class="mb-4 text-center">
    <i class="bi bi-building-fill me-2 text-primary"></i> Manage Rooms
</h3>

@if (!string.IsNullOrEmpty(_message))
{
    <div class="alert alert-success text-center">
        @_message
    </div>
}

<div class="card p-4 shadow-sm mb-4">
    <div class="d-flex justify-content-center mb-3">
        <button class="btn btn-success"
                style="min-width: 200px;"
                @onclick="() => { _showCreateForm = true; }">
            <i class="bi bi-plus-circle me-1"></i>Create Room
        </button>
    </div>

    @if (_showCreateForm)
    {
        <div class="card p-3 mb-3 shadow-sm">
            <h6>Create Room</h6>
            <input class="form-control mb-2" placeholder="Room Number" @bind="_roomNumber" />
            <input class="form-control mb-2" type="number" placeholder="Capacity" @bind="_capacity" />
            <input class="form-control mb-2" type="number" step="0.01" placeholder="Price" @bind="_pricePerNight" />

            <button class="btn btn-success w-100" @onclick="CreateRoom">Save</button>
        </div>
    }

    <button class="btn btn-primary w-100" @onclick="ShowRooms">
        Show All Rooms
    </button>
</div>

@if (_showAllRooms)
{
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Number</th>
                <th>Capacity</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (rooms != null && rooms.Any())
            {
                @foreach (var room in rooms)
                {
                    <tr>
                        <td>
                            <a href="/room-details/@room.Id">@room.Number</a>
                        </td>
                        <td>@room.Capacity</td>
                        <td>@room.PricePerNight</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" @onclick="() => NavigateToEdit(room.Id)"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteConfirm(room.Id)"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="4" class="text-center">No rooms to display</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private bool _showCreateForm = false;
    private bool _showAllRooms = false;

    private string _roomNumber = string.Empty;
    private int _capacity;
    private decimal _pricePerNight;
    private string _message = string.Empty;

    // List to hold rooms fetched from API
    private List<Client.Models.RoomDto>? rooms = new();

    // Fetch rooms when "Show All Rooms" button is clicked
    private async Task ShowRooms()
    {
        _showAllRooms = true;

        try
        {
            rooms = await Http.GetFromJsonAsync<List<Client.Models.RoomDto>>("api/rooms") ?? new List<Client.Models.RoomDto>();
        }
        catch (Exception ex)
        {
            _message = $"Error loading rooms: {ex.Message}";
        }
    }

    private async Task CreateRoom()
    {
        var command = new
        {
            Number = _roomNumber,
            Capacity = _capacity,
            PricePerNight = _pricePerNight
        };

        try
        {
            var response = await Http.PostAsJsonAsync("api/rooms", command);

            if (response.IsSuccessStatusCode)
            {
                _message = "Room created successfully!";
                _roomNumber = string.Empty;
                _capacity = 0;
                _pricePerNight = 0;

                // Refresh list if table is visible
                if (_showAllRooms)
                {
                    rooms = await Http.GetFromJsonAsync<List<Client.Models.RoomDto>>("api/rooms")
                            ?? new List<Client.Models.RoomDto>();
                }
            }
            else
            {
                _message = $"Error: {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            _message = $"Exception: {ex.Message}";
        }
    }

    private void NavigateToEdit(int roomId)
    {
        Navigation.NavigateTo($"/manage/rooms/edit/{roomId}");
    }

    async Task DeleteConfirm(int roomId)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure?");
        if (confirmed)
        {
            var response = await Http.DeleteAsync($"api/rooms/{roomId}");

            if (response.IsSuccessStatusCode)
            {
                _message = "Room succesfully Deleted";
            }
        }
    }
}
