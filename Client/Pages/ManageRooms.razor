@page "/manage/rooms"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime
@using Client.Models

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">Manage Rooms</h3>

    <button class="btn btn-success"
            @onclick="() => _showCreateForm = !_showCreateForm">
        <i class="bi bi-plus-circle me-1"></i>
        @(_showCreateForm ? "Cancel" : "Create Room")
    </button>
</div>

@if (!string.IsNullOrEmpty(_message))
{
    <div class="alert alert-success text-center">
        @_message
    </div>
}

@if (_showCreateForm)
{
    <div class="card p-3 mb-4 shadow-sm">

        <div class="mb-3">
            <label class="form-label">Room number</label>
            <input class="form-control mb-2"
                   type="text"
                   placeholder="Enter room number"
                   @bind="_roomNumber" />
        </div>

        <div class="mb-3">
            <label class="form-label">Capacity</label>
            <input class="form-control mb-2"
                   type="number"
                   placeholder="Enter capacity"
                   @bind="_capacity" />
        </div>

        <div class="mb-3">
            <label class="form-label">Price per night</label>
            <input class="form-control mb-3"
                   type="number"
                   step="0.01"
                   placeholder="Enter price"
                   @bind="_pricePerNight" />
        </div>

        <button class="btn btn-success w-100" @onclick="CreateRoom">Save</button>
    </div>
}

<table class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th>Number</th>
            <th>Capacity</th>
            <th>Price</th>
            <th style="width: 140px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (rooms != null && rooms.Any())
        {
            @foreach (var room in rooms)
            {
                <tr>
                    <td>
                        <a href="/room-details/@room.Id">@room.Number</a>
                    </td>
                    <td>@room.Capacity</td>
                    <td>@room.PricePerNight</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" @onclick="() => NavigateToEdit(room.Id)">   <i class="bi bi-pencil"></i>  </button>
                        <button class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="4" class="text-center text-muted">
                    No rooms found
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    private bool _showCreateForm;
    private string _roomNumber = string.Empty;
    private int _capacity;
    private decimal _pricePerNight;
    private string _message = string.Empty;

    private List<Client.Models.RoomDto> rooms = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRooms();
    }

    private async Task LoadRooms()
    {
        try
        {
            rooms = await Http.GetFromJsonAsync<List<RoomDto>>("api/rooms") ?? new List<RoomDto>();
        }
        catch (Exception ex)
        {
            _message = $"Error loading rooms: {ex.Message}";
        }
    }

    private async Task CreateRoom()
    {
        var command = new
        {
            Number = _roomNumber,
            Capacity = _capacity,
            PricePerNight = _pricePerNight
        };

        try
        {
            var response = await Http.PostAsJsonAsync("api/rooms", command);

            if (response.IsSuccessStatusCode)
            {
                _message = "Room created successfully!";
                _roomNumber = string.Empty;
                _capacity = 0;
                _pricePerNight = 0;
                _showCreateForm = false;

                await LoadRooms();
            }
        }
        catch (Exception ex)
        {
            _message = $"Exception: {ex.Message}";
        }
    }

    private void NavigateToEdit(int roomId)
    {
        Navigation.NavigateTo($"/manage/rooms/edit/{roomId}");
    }

    async Task DeleteConfirm(int roomId)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure?");
        if (confirmed)
        {
            var response = await Http.DeleteAsync($"api/rooms/{roomId}");

            if (response.IsSuccessStatusCode)
            {
                _message = "Room succesfully Deleted";
            }
        }
    }
}
